【方針】
- 固定の言語別パターンは使わず、文書中の反復構造から「見出し規則」を誘導（induce）する。
- 構造・体裁・連番・周辺本文の統計・話題遷移の一貫性で見出し候補をスコア化し、最適仮説を採択。
- 採択仮説は logs.detection_profile に簡潔に記録（推論過程そのものは出力しない）。

【ステップ1: 正規化とノイズ除去】
- Unicode正規化（NFKC）。連続空白は1つに統一。行末のハイフネーション(-\n)は結合。
- 反復ヘッダ/フッタは3回以上の反復で削除。目次（ドットリーダ＋末尾ページ番号が多発するブロック）は除去。
- 単独ページ番号行、罫線行は除去。段落は空行2つで分離。

【ステップ2: 見出し候補の自動収集（言語非依存）】
- 候補になりやすい行を多面的に収集（複数条件の“いずれか”を満たす行）:
  - 文字種・外形: 行長8〜120、句読点少、記号密度低、Title Case/ALL CAPS/先頭が数字・記号・記号＋数字など規則性。
  - レイアウト: 前後に空行、同一書式（全角/半角/大文字化）が反復、センタリング風（前後が短行）。
  - 連番の兆候: 先頭トークンが連番（算用数字/漢数字/ローマ数字/他の数字体系）や序数語らしきもの。
  - 周辺本文の存在: 候補直後1〜5行に本文らしさ（平均行長>20、句点/ピリオドなど）。
- 言語は仮定しない。数字体系は Unicode の Decimal_Number/Letter_Number/Other_Number に基づくトークン化で検知。

【ステップ3: 見出し規則の仮説生成（誘導）】
- 候補集合の中から、以下が高頻度で一貫するテンプレート（仮説）を誘導:
  - 例: "<ラベル語> <連番> [: -] <タイトル本文?>", "<連番>. <タイトル>", "<ALL CAPSのみ>"
  - 例: 「第 + 数字 + 章 + タイトル」「PART/UNIT/BOOK など」も“結果として”抽出されうるが、事前定義はしない。
- 仮説ごとに、文書全体での**適用件数・連番の単調増加・見出し間隔（語数）・タイトル多様性**を評価。

【ステップ4: スコアリングと採択】
- スコア項目（合算して章開始候補スコア S を算出）:
  + 反復整式性（同形テンプレートの命中数/全候補）: +0〜+3
  + 連番の整合（番号が1方向に増加、飛び号が稀）: +0〜+3
  + レイアウト手掛かり（前後空行・センタリング風）: +0〜+2
  + 本文近接（直後に本文らしさ）: +0〜+2
  − 目次/付録/図表/参考文献等の典型語に近似: −0〜−3
  − 行長極端/記号過多などノイズ指標: −0〜−2
- 仮説ごとに平均 S と分散、章間隔の安定性を比較し、**最良仮説**を採択。
- 章境界は「採択仮説に合致する見出し行」を開始として、次の見出し直前まで。

【ステップ5: タイトル抽出・信頼度】
- タイトルは見出し行末の残部、なければ次行・次々行の短行から抽出。20〜30字が望ましい。
- 信頼度:
  - High: 適用件数が十分（少なくとも3章以上）で、連番・間隔・本文近接が整合。
  - Mid: 仮説は立つが1〜2章しか取れない/一部要件が弱い。
  - Low: 明示的見出しパターンが成立せず、話題遷移による章風セグメント（下記ステップ6）に縮退。
- Mid/Low は summary 先頭に注記:  
  - Mid: 「注: 章境界は見出し規則を推定して抽出」  
  - Low: 「注: 明確な見出しがなく、話題遷移で章風に分割」

【ステップ6: 章なし縮退（話題遷移セグメンテーション）】
- 見出し仮説が弱い場合、**話題一貫性**で大区切りを推定して章相当ブロックを作る:
  - 方法: 段落ベースで埋め込み類似度の変化点検出（TextTiling/C99相当のギャップ検出を概念的に適用）。
  - 変化点密度が低い大ブロックを章として扱う（最小長しきい値: 1000語程度を目安）。
  - タイトルは先頭300字から名詞句抽出で20〜30字命名し、summary 末尾に「（章題は本文要旨から命名）」を付記。
- CHAPTER_RANGE がある場合は、抽象章番号にマッピング（例: 検出順の1..N）して範囲を適用。

【ステップ7: ログの透明性（jsonモード推奨）】
- "logs": {
    "detection_profile": {
      "template": "〈推定テンプレートの簡易表現〉",     // 例: "<LABEL> <NUM> - <TITLE>"
      "examples": ["…実例1…","…実例2…"],              // 先頭2例のみ
      "level_hints": ["PART/BOOK相当パターン検知 3件"],
      "confidence": "High|Mid|Low"
    },
    "skipped": [{ "file": "…", "reason": "テキスト層なし/目次のみ/重複" }],
    "warnings": ["第3章が取得困難: 近接見出し密度不足のため縮退 など"]
  }
